{% load i18n static sass_tags core_utils %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>{% block title %}Countastic{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
    <script src="https://kit.fontawesome.com/0b23f4de3d.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.0/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="{% static "core/js/element.scrollintoviewifneeded-polyfill.js" %}"></script>
    <link rel="stylesheet" href="{% sass_src "core/scss/bs-addons.scss" %}" />
    <link rel="stylesheet" href="{% sass_src "core/scss/bs-override.scss" %}" />
    <link rel="stylesheet" href="{% sass_src "core/scss/bs-extensions-override.scss" %}" />
    <link rel="stylesheet" href="{% sass_src "core/scss/main_components.scss" %}" />
    <link rel="stylesheet" href="{% sass_src "core/scss/components.scss" %}" />
    <link rel="stylesheet" href="{% sass_src "core/scss/main.scss" %}" />
    <link rel="stylesheet" href="{% sass_src "core/scss/theme.scss" %}" />
    {% block head_end %}{% endblock %}
</head>

<body>

    <nav class="container-fluid hstack-full gap-5 px-6 pt-1 mb-3">
        {% if main_object or request.path == home_url and user.is_authenticated %}
            <a class="w-2" href="{% if request.path != home_url %}{{ home_url }}{% if date_str %}?date={{ date_str }}{% endif %}{% else %}/{% endif %}">
                {% icon "house-blank" "solid" %}
            </a>
        {% else %}
            <a href="/">Countastic</a>
        {% endif %}

        {% if main_object or request.path == home_url and user.is_authenticated %}
            <div id="navbar-date-interval" class="hstack-full gap-4">
                {% if interval != "none" %}
                    <div class="nav-item flex-grow-0">
                        <a class="text-decoration-none nav-link d-inline" title="Previous {{ interval_name }}" href="{{ request.path }}?date={{ prev_date|date:"Y-m-d" }}&interval={{ interval }}">{% icon "chevron-left" "solid" %}</a>
                    </div>
                {% endif %}
                <div class="nav-item dropdown flex-shrink-1">
                    <a class="nav-link dropdown-toggle text-wrap text-center" href="#" id="date-interval-selector" role="button" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
                        {% interval_str date interval %}
                    </a>
                    <div class="dropdown-menu dropdown-menu-center position-absolute" aria-labelledby="date-interval-selector">
                        <form class="px-2" action="{{ request.path }}" method="get">
                            <div class="input-group">
                                <input name="date" type="date" value="{{ current_date|date:'Y-m-d' }}" required pattern="\d{4}-\d{2}-\d{2}" class="form-control form-control-sm" aria-label="Select date">
                                <button class="btn btn-sm btn-outline-primary" type="submit">Go</button>
                            </div>
                            <a class="mb mb-3 d-inline-block" href="{{ request.path }}?date={{ today|date:'Y-m-d' }}{% if interval %}&interval={{ interval }}{% endif %}">Set to today</a>
                            <p class="mb-1">View for:</p>
                            {% for interval_choice in intervals %}
                                <div class="form-check ms-2">
                                    <input class="form-check-input" name="interval"{% if not project and interval == interval_choice %} checked{% elif project and interval|default:project.interval == interval_choice %} checked{% endif %} type="radio" value="{{ interval_choice.value }}" id="interval-{{ interval_choice }}">
                                    <label class="form-check-label pe-1" for="interval-{{ interval_choice }}">
                                        {{ interval_choice.unit_name|capfirst }}
                                        {% if project.interval == interval_choice %}<span class="text-muted"> (project default)</span>{% endif %}
                                    </label>
                                </div>
                            {% endfor %}
                            {% if not project %}
                                <div class="form-check ms-2">
                                    <input class="form-check-input" name="interval"{% if not interval %} checked{% endif %} type="radio" value="" id="interval-default">
                                    <label class="form-check-label pe-1" for="interval-default">Default by project</label>
                                </div>
                            {% endif %}
                        </form>
                    </div>
                </div>
                {% if interval != "none" %}
                    <div class="nav-item flex-grow-0">
                        <a class="text-decoration-none nav-link d-inline" title="Next {{ interval_name }}" href="{{ request.path }}?date={{ next_date|date:"Y-m-d" }}&interval={{ interval }}">{% icon "chevron-right" "solid" %}</a>
                    </div>
                {% endif %}
            </div>
        {% endif %}

        <div class="justify-content-between flex-grow-0 w-2" id="navbar-content">
            {% if user.is_authenticated %}
                <span class="navbar-text"></span>{# hack to have the date centered and user menu at the end #}
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="user_authenticated_dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            {% icon "user" "solid" %}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="user_authenticated_dropdown">
                            <li><a class="dropdown-item" href="{% url 'password_change' %}">{% trans "Change password" %}</a></li>
                            <li><a class="dropdown-item" href="{% url 'logout' %}">{% trans "Log out" %}</a></li>
                        </ul>
                    </li>
                </ul>
            {% else %}
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="{% url 'login' %}">{% trans "Log in" %}</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'django_registration_register' %}">{% trans "Register" %}</a></li>
                </ul>
            {% endif %}
        </div>
    </nav>

    {% if messages %}
        <div id="messages" class="container-fluid m-1 p-5 mt-0 pt-0">
            {% for message in messages %}
                <div class="callout callout-{{ message.level_tag }}" role="alert">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    {% block pre-content %}{% endblock %}


    <div id="content" class="container-fluid p-6 pt-0">
            {% block content %}{% endblock %}
    </div>

    <div id="footer" class="mt-3">
    {% block footer %}
    {% endblock %}
    </div>

    <script type="text/javascript">
        // when a details element is opened, close the other ones having the same data-group attribute, if any
        // and make it visible
        document.addEventListener('toggle', ev => {
            if (ev.target.nodeName !== 'DETAILS' || !ev.target.open) { return; }
            const group = ev.target.getAttribute('data-group');
            if (group) {
                document.querySelectorAll('details[data-group="' + group + '"][open]').forEach(el => {
                    if (el !== ev.target) { el.open = false; }
                });
            }
            if (ev.target.classList.contains('scroll-into-view')) {
                const scroll_elt_selector = ev.target.getAttribute('data-scroll-into-view');
                setTimeout(() => (scroll_elt_selector ? ev.target.querySelector(scroll_elt_selector) : ev.target)?.scrollIntoViewIfNeeded(), 50)
            }
        }, true);
        // focus on the first input field when a details element with "focus-first-input" class is opened
        document.addEventListener('toggle', ev => {
            if (ev.target.nodeName === 'DETAILS' && ev.target.open && ev.target.classList.contains('focus-first-input')) {
                const input_selector = ev.target.getAttribute('data-focus-first-input') || 'input:not([type="hidden"]),select,textarea';
                ev.target.querySelectorAll(input_selector)[0]?.focus();
            }
        }, true);
        // focus on the first input field when a tab with the "focus-first-input" class is shown, and make the tab visible
        document.addEventListener('shown.bs.tab', ev => {
            if (ev.target.classList.contains('focus-first-input')) {
                const tab_content = document.querySelector(ev.target.getAttribute('data-bs-target'));
                const input_selector = ev.target.getAttribute('data-focus-first-input') || 'input:not([type="hidden"]),select,textarea';
                tab_content.querySelectorAll(input_selector)[0]?.focus();
            }
            if (ev.target.classList.contains('scroll-into-view')) {
                const tab_content = document.querySelector(ev.target.getAttribute('data-bs-target'));
                setTimeout(() => tab_content.scrollIntoViewIfNeeded(), 50)
            }
        }, true);
        // activate datepickers when details element is opened or tab is shown
        const activate_datepicker = elt => elt.querySelectorAll('.datepicker-container').forEach(elt => {if (!elt._flatpickr) { flatpickr(elt) }})
        document.addEventListener('toggle', ev => { if (ev.target.nodeName === 'DETAILS') { activate_datepicker(ev.target); } }, true);
        document.addEventListener('shown.bs.tab', ev => { activate_datepicker(document.querySelector(ev.target.getAttribute('data-bs-target'))) });
        // create select2 elements when selects with "autocomplete" class are focused
        document.addEventListener("focusin", ev => {
            if (ev.target.nodeName !== 'SELECT' || !ev.target.classList.contains('autocomplete')) { return; }
            ev.preventDefault();
            ev.stopImmediatePropagation();
            setTimeout(() => {
                let $target = $(ev.target);
                $target.select2({theme: 'bootstrap-5', dropdownAutoWidth: true, dropdownCssClass: ev.target.closest('form.small-form') ? 'select2-dropdown-sm' : ''});
                $target.select2('open');
            }, 500);
        });

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2" crossorigin="anonymous"></script>
</body>

</html>
