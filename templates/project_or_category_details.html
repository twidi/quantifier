{% extends "project_or_category_base.html" %}
{% load i18n sass_tags mptt_tags core_utils %}

{% block head_end %}
    {{ block.super }}
    <link rel="stylesheet" href="{% sass_src "core/scss/pages/project_or_category.scss" %}" />
{% endblock %}

{% block project_content %}

    {{ block.super }}

    {% with all_summed_quantities=project.summed_quantities %}
        <div id="main-categories" class="hstack flex-wrap gap-5 justify-content-center align-items-stretch">

        {% for category in categories %}
            {% with summed_quantities=project.summed_quantities|dict_value:category %}
                <div class="card vstack gap-5 p-5 w-max-r20 flex-grow-0">
                    <div class="hstack gap-2 align-items-baseline">
                        <a class="fs-1 text-decoration-none" href="{{ category.get_absolute_url }}?date={{ date_str }}{% if interval %}&interval={{ interval }}{% endif %}">
                            {{ category.name }}
                        </a>
                        {% with nb_children=category.get_children|length %}
                            {% if nb_children %}
                                <span class="text-muted">+{{ nb_children }}</span>
                            {% endif %}
                        {% endwith %}
                    </div>
                    <div class="hstack gap-3 justify-content-start align-items-start">
                        <div class="vstack align-items-end flex-grow-0">
                            <div class="w-min-3 text-center fs-2 px-3 py-2 rounded-3 bg-white-5 {% if summed_quantities.goal_reached %}text-success{% elif summed_quantities.limit_exceeded %}text-danger{% endif %}">
                                {{ summed_quantities.used }}
                            </div>
                            {% if summed_quantities.expected %}
                                <div class="text-muted">/ {{ summed_quantities.expected }}</div>
                            {% endif %}
                        </div>
                        <details class="mt-2 no-marker as-dropdown category-forms-container focus-first-input scroll-into-view" data-group="category_forms" data-scroll-into-view=".card">
                            <summary class="d-flex gap-3 align-items-center" title="Click to add a quantity, a sub-category or edit/delete this category">
                                <span class="details-toggle">
                                    <span class="btn btn-round btn-secondary details-toggle-open">
                                        {% icon "plus" "solid" size="xl" %}
                                    </span>
                                    <span class="btn btn-round btn-secondary details-toggle-close">
                                        {% icon "xmark" "solid" %}
                                    </span>
                                </span>
                            </summary>
                            <div class="card details-dropdown category-forms">
                                <div class="card-body">
                                    {% quantity_in_category_form category=category next_category=category initial_value=summed_quantities.self_expected_not_used %}
                                </div>
                            </div>
                        </details>
                    </div>
                </div>
            {% endwith %}
        {% endfor %}

        {% if current_category %}
            {% with summed_quantities=all_summed_quantities|dict_value:category %}
                {% if current_category.has_children %}
                    {% if summed_quantities.self_used or summed_quantities.self_exptected %}
                        {% if summed_quantities.self_used != summed_quantities.used or summed_quantities.self_expected != summed_quantities.expected %}
                            <div class="card vstack gap-5 p-5 w-max-r20 flex-grow-0">
                                <div class="hstack gap-2 align-items-baseline">
                                    <span class="fs-1 text-decoration-none text-muted">
                                        Unclassified
                                    </span>
                                </div>
                                <div class="hstack align-items-start">
                                    <div class="w-min-3 text-center fs-2 px-3 py-2 rounded-3 bg-white-5 {% if summed_quantities.goal_reached %}text-success{% elif summed_quantities.limit_exceeded %}text-danger{% endif %}">
                                        {{summed_quantities.self_used }}
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endif %}
                {% endif %}
            {% endwith %}
        {% endif %}

        <div class="card hstack p-5 justify-content-center align-items-center w-max-r20">
            <details class="no-marker as-dropdown category-forms-container focus-first-input scroll-into-view" data-group="category_forms" data-scroll-into-view=".card-body">
                <summary class="hstack gap-3">
                    <span class="fs-1 text-decoration-none text-muted">Add a category</span>
                    <span class="details-toggle">
                        <span class="btn btn-round btn-secondary details-toggle-open">
                            {% icon "plus" "solid" size="xl" %}
                        </span>
                        <span class="btn btn-round btn-secondary details-toggle-close">
                            {% icon "xmark" "solid" %}
                        </span>
                    </span>
                </summary>
                <div class="card details-dropdown category-forms">
                    <div class="card-body">
                        {% if category %}
                            {% category_form project=project parent_category=category next_category=category %}
                        {% else %}
                            {% category_form project=project %}
                        {% endif %}
                    </div>
                </div>
            </details>
        </div>

        </div>
    {% endwith %}

    {% if project.quick_add_quantities %}
        <datalist id="project-{{ project.pk }}-quick_add_quantities">
            {% for qtt in project.quick_add_quantities_as_list %}
                <option value="{{ qtt }}">
            {% endfor %}
        </datalist>
    {% endif %}

    <a class="text-muted fs-2 bottom-0 end-0 position-fixed rounded-circle m-3 d-flex justify-content-center align-items-center" title="List/edit/delete entered quantities" id="manage-quantities-button" href="{{ main_object.get_quantities_url }}?date={{ date_str }}&interval={{ interval }}">
        {% icon "square-list" classes="fa-fw" %}
    </a>

{% endblock project_content %}
