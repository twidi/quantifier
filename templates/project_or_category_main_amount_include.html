{% load core_utils %}
<div class="main-amount fs-2 text-muted m-3 d-flex flex-column gap-2 justify-content-center {{ css_classes }}">
{% with interval=interval|default:project.interval %}

{% if not current_category and not project.has_interval_quantity %}
    <span class="text-center">{{ summed_quantities.used }} {{ project.quantity_name }}</span>
    <div class="small text-muted text-end pt-1">{% if interval == "none" %}(all time){% else %}this {% with interval=interval|interval %}{{ interval.unit_name }}{% endwith %}{% endif %}</div>
{% elif current_category %}
    {% if project.goal_mode and interval and interval|interval > project.interval|interval  %}
        <span class="text-center">{{ summed_quantities.used }} {{ project.quantity_name }}</span>
    {% elif project.goal_mode and summed_quantities.expected and summed_quantities.used >= summed_quantities.expected %}
        <span class="small text-success">Goal reached</span>
        <span class="text-center">{{ summed_quantities.used }} {{ project.quantity_name }}</span>
    {% elif project.goal_mode and summed_quantities.expected %}
        <span class="small text-warning">Left</span>
        <span class="text-center">{{ summed_quantities.expected_not_used }} {{ project.quantity_name }}</span>
    {% elif summed_quantities.expected and summed_quantities.used > summed_quantities.expected %}
        <span class="small text-danger">Excess</span>
        <span class="text-center">{{ summed_quantities.used }} {{ project.quantity_name }}</span>
    {% else %}
        <span class="text-center">{{ summed_quantities.used }} {{ project.quantity_name }}</span>
    {% endif %}
    {% if summed_quantities.expected %}
        <div class="small text-muted text-end d-flex align-items-baseline justify-content-end">
            <span class="text-muted align-self-center ms-2">/</span>
            <span class="text-muted mt-1">
                {{ summed_quantities.expected }}
                planned{% if interval != "none" %} this {% with interval=interval|interval %}{{ interval.unit_name }}{% endwith %}{% endif %}
            </span>
        </div>
    {% else %}
        <div class="small text-muted text-end pt-1">{% if interval == "none" %}(all time){% else %}this {% with interval=interval|interval %}{{ interval.unit_name }}{% endwith %}{% endif %}</div>
    {% endif %}
{% elif interval == "none" and project.interval != "none" %}
    <span class="text-center">{{ summed_quantities.used }} {{ project.quantity_name }}</span>
    <div class="small text-muted text-end pt-1">{% if interval == "none" %}(all time){% else %}this {% with interval=interval|interval %}{{ interval.unit_name }}{% endwith %}{% endif %}</div>
{% elif project.has_interval and interval and interval|interval < project.interval|interval %}
    <span class="text-center">{{ summed_quantities.used }} {{ project.quantity_name }}</span>
    <div class="small text-muted text-end pt-1">{% if interval == "none" %}(all time){% else %}this {% with interval=interval|interval %}{{ interval.unit_name }}{% endwith %}{% endif %}</div>
{% elif not project.has_interval and interval and interval != "none" %}
    <span class="text-center">{{ summed_quantities.used }} {{ project.quantity_name }}</span>
    <div class="small text-muted text-end pt-1">{% if interval == "none" %}(all time){% else %}this {% with interval=interval|interval %}{{ interval.unit_name }}{% endwith %}{% endif %}</div>
{% else %}
    {% if project.goal_mode and interval and interval|interval > project.interval|interval  %}
    <span class="text-center">{{ summed_quantities.used }} {{ project.quantity_name }}</span>
    {% elif project.goal_mode and summed_quantities.available <= 0 %}
        <span class="small text-success">Goal reached</span>
        <span class="text-center">{{ summed_quantities.used }} {{ project.quantity_name }}</span>
    {% elif project.goal_mode and summed_quantities.available >= 0 %}
        <span class="small text-warning">Left</span>
        <span class="text-center">{{ summed_quantities.available }} {{ project.quantity_name }}</span>
    {% elif summed_quantities.really_available >= 0 %}
        <span class="small">Left</span>
        <span class="text-center">{{ summed_quantities.really_available }} {{ project.quantity_name }}</span>
    {% else %}
        <span class="small text-danger">Excess</span>
        <span class="text-center d-flex gap-2"><span class="text-danger fs-4">-</span>{{ summed_quantities.really_available|mul:-1 }} {{ project.quantity_name }}</span>
    {% endif %}
    <div class="small text-muted text-end d-flex align-items-baseline justify-content-end">
        <span class="text-muted align-self-center ms-2">/</span>
        <span class="text-muted">
            {% if project.goal_mode %}{{ summed_quantities.interval_quantity }}{% else %}{{ summed_quantities.total_unexpected }}{% endif %}
            {% if interval == "none" %}(all time){% else %}this {% with interval=interval|interval %}{{ interval.unit_name }}{% endwith %}{% endif %}
        </span>
        {% if not project.goal_mode %}
        <details class="no-marker as-dropdown d-inline-block text-start" data-group="main-amount-info">
            <summary class="text-muted p-2" title="What are these numbers?">
                <span class="details-toggle">
                    {% icon "circle-question" classes="details-toggle-open" %}
                    {% icon "circle-xmark" classes="details-toggle-close" %}
                </span>
            </summary>
            <div class="details-dropdown bg-white top-100 mt--3">
                <div class="callout callout-info m-0">
                    <p class="mb-0">
                        <strong>{{ summed_quantities.total_unexpected }}</strong> is the {% if interval == "none" %}all time{% else %}{{ interval }}{% endif %} amount (<strong>{{ project.interval_quantity }}</strong>{% if interval != project.interval %} per {% with interval=project.interval|interval %}{{ interval.unit_name }}{% endwith %}{% endif %}) minus the planned one (<strong>{{ summed_quantities.expected }}</strong>)
                    </p>
                    <p class="mb-0 mt-3">
                    {% if summed_quantities.used %}
                            <strong>{{ summed_quantities.really_available }}</strong> is the previous amount (<strong>{{ summed_quantities.total_unexpected }}</strong>) minus what was not planned (<strong>{{ summed_quantities.used_not_expected }}</strong>) and the excess over what was planned in some categories (<strong>{{ summed_quantities.unexpected }}</strong>)
                    {% else %}
                        No usage {% if interval == "none" %} (all time){% else %}during this {% with interval=interval|interval %}{{ interval.unit_name }}{% endwith %}{% endif %}
                    {% endif %}
                    </p>
                </div>
            </div>
        </details>
        {% endif %}
    </div>
{% endif %}
{% endwith %}
</div>
